<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" integrity="sha256-Z1K5uhUaJXA7Ll0XrZ/0JhX4lAtZFpT6jkKrEDT0drU=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"zhangzr.com","root":"/","images":"/images","scheme":"Mist","darkmode":false,"version":"8.14.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="DD-WRT配置">
<meta property="og:type" content="article">
<meta property="og:title" content="DD-WRT安装与配置">
<meta property="og:url" content="http://zhangzr.com/2018/09/04/DD-WRT/index.html">
<meta property="og:site_name" content="大象无形，大音希声">
<meta property="og:description" content="DD-WRT配置">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://zhangzr.com/dd-wrt_1.png">
<meta property="og:image" content="http://zhangzr.com/dd-wrt_2.png">
<meta property="og:image" content="http://zhangzr.com/USB_support.jpg">
<meta property="og:image" content="http://zhangzr.com/dd-wrt_3.png">
<meta property="article:published_time" content="2018-09-03T16:17:53.000Z">
<meta property="article:modified_time" content="2021-11-25T02:45:58.000Z">
<meta property="article:author" content="Tiki">
<meta property="article:tag" content="DD-WRT">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://zhangzr.com/dd-wrt_1.png">


<link rel="canonical" href="http://zhangzr.com/2018/09/04/DD-WRT/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://zhangzr.com/2018/09/04/DD-WRT/","path":"2018/09/04/DD-WRT/","title":"DD-WRT安装与配置"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>DD-WRT安装与配置 | 大象无形，大音希声</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">大象无形，大音希声</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">嘘......</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#DD-WRT%E9%85%8D%E7%BD%AE"><span class="nav-number">1.</span> <span class="nav-text">DD-WRT配置</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#nvram%E5%91%BD%E4%BB%A4"><span class="nav-number">1.1.</span> <span class="nav-text">nvram命令</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JFFS-Journalling-Flash-File-System"><span class="nav-number">1.2.</span> <span class="nav-text">JFFS(Journalling Flash File System)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8WEB-GUI%E7%95%8C%E9%9D%A2%E5%90%AF%E7%94%A8JFFS"><span class="nav-number">1.2.1.</span> <span class="nav-text">使用WEB GUI界面启用JFFS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%91%BD%E4%BB%A4%E8%A1%8C%E6%96%B9%E5%BC%8F%E5%90%AF%E5%8A%A8JFFS%EF%BC%9ACLI"><span class="nav-number">1.2.2.</span> <span class="nav-text">命令行方式启动JFFS：CLI</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A2%9E%E5%8A%A0JFFS%E7%A9%BA%E9%97%B4%E7%9A%84%E6%96%B9%E6%B3%95"><span class="nav-number">1.2.3.</span> <span class="nav-text">增加JFFS空间的方法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A2%9E%E5%8A%A01G%E9%97%AA%E5%AD%98%E5%8D%A1"><span class="nav-number">1.2.3.1.</span> <span class="nav-text">增加1G闪存卡</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0USB%E5%AD%98%E5%82%A8%E8%AE%BE%E5%A4%87"><span class="nav-number">1.2.3.2.</span> <span class="nav-text">添加USB存储设备</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95ipkg"><span class="nav-number">1.2.3.3.</span> <span class="nav-text">测试ipkg</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Entware%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE"><span class="nav-number">1.3.</span> <span class="nav-text">Entware安装与配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%95%E8%A8%80"><span class="nav-number">1.3.1.</span> <span class="nav-text">引言</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="nav-number">1.3.2.</span> <span class="nav-text">准备工作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85"><span class="nav-number">1.3.3.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DD-WRT%E5%9B%BA%E4%BB%B6%E5%8D%87%E5%8F%8A%E5%AF%B9%E4%BA%8EEntware%E7%9A%84%E5%BD%B1%E5%93%8D"><span class="nav-number">1.3.4.</span> <span class="nav-text">DD-WRT固件升及对于Entware的影响</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#EntWare-WiKi"><span class="nav-number">1.3.5.</span> <span class="nav-text">EntWare WiKi</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8%E8%84%9A%E6%9C%AC"><span class="nav-number">1.4.</span> <span class="nav-text">启动脚本</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%A8%E8%B7%AF%E7%94%B1%E5%99%A8%E4%B8%8A%E5%8A%A0%E8%BD%BD%E8%84%9A%E6%9C%AC%E7%9A%84WEB%E7%95%8C%E9%9D%A2%E6%96%B9%E6%B3%95"><span class="nav-number">1.4.1.</span> <span class="nav-text">在路由器上加载脚本的WEB界面方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NVRAM%E6%96%B9%E6%B3%95"><span class="nav-number">1.4.2.</span> <span class="nav-text">NVRAM方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Shell%E8%84%9A%E6%9C%AC%E6%96%B9%E6%B3%95"><span class="nav-number">1.4.3.</span> <span class="nav-text">Shell脚本方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E8%84%9A%E6%9C%AC%E7%9A%84%E4%B8%8D%E5%90%8C%E7%9B%AE%E5%BD%95"><span class="nav-number">1.4.4.</span> <span class="nav-text">配置脚本的不同目录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BE%E4%BE%8B%EF%BC%9Asamba%E5%90%AF%E5%8A%A8%E8%84%9A%E6%9C%AC"><span class="nav-number">1.4.5.</span> <span class="nav-text">举例：samba启动脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BE%E4%BE%8B%EF%BC%9Anginx%E5%90%AF%E5%8A%A8%E8%84%9A%E6%9C%AC"><span class="nav-number">1.4.6.</span> <span class="nav-text">举例：nginx启动脚本</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Entware%E5%AE%89%E8%A3%85%E5%BA%94%E7%94%A8%E8%AE%BE%E7%BD%AE%E5%BC%80%E6%9C%BA%E5%90%AF%E7%94%A8"><span class="nav-number">1.5.</span> <span class="nav-text">Entware安装应用设置开机启用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DNSMasq%E9%85%8D%E7%BD%AE%E6%9C%AC%E5%9C%B0%E7%BD%91%E7%BB%9C"><span class="nav-number">1.6.</span> <span class="nav-text">DNSMasq配置本地网络</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%90%AF%E5%8A%A8dnsmasq"><span class="nav-number">1.6.1.</span> <span class="nav-text">1. 启动dnsmasq</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%90%AF%E5%8A%A8%E6%9C%AC%E5%9C%B0DNS"><span class="nav-number">1.6.2.</span> <span class="nav-text">2. 启动本地DNS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-DNSMasq-%E9%99%84%E5%8A%A0%E9%80%89%E9%A1%B9%EF%BC%9A"><span class="nav-number">1.6.3.</span> <span class="nav-text">3. DNSMasq 附加选项：</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#dnsmasq%E8%AF%A6%E8%A7%A3%E5%8F%8A%E9%85%8D%E7%BD%AE"><span class="nav-number">2.</span> <span class="nav-text">dnsmasq详解及配置</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Dnsmasq%E7%9A%84%E4%B8%BB%E8%A6%81%E4%BD%9C%E7%94%A8"><span class="nav-number">2.1.</span> <span class="nav-text">Dnsmasq的主要作用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Dnsmasq%E7%9A%84%E8%A7%A3%E6%9E%90%E6%B5%81%E7%A8%8B"><span class="nav-number">2.2.</span> <span class="nav-text">Dnsmasq的解析流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Dnsmasq%E7%9A%84%E5%8F%82%E6%95%B0%E5%8F%8A%E5%B8%B8%E7%94%A8%E8%AE%BE%E7%BD%AE%E8%AF%B4%E6%98%8E"><span class="nav-number">2.3.</span> <span class="nav-text">Dnsmasq的参数及常用设置说明</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%8F%E5%B8%B8%E4%BF%AE%E6%94%B9%E7%9A%84%E6%AF%94%E8%BE%83%E9%87%8D%E8%A6%81%E7%9A%84%E5%8F%82%E6%95%B0%E8%AF%B4%E6%98%8E"><span class="nav-number">2.3.1.</span> <span class="nav-text">经常修改的比较重要的参数说明</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%AF%AD%E6%B3%95%E6%98%AF%E5%90%A6%E6%AD%A3%E7%A1%AE%EF%BC%8C%E5%8F%AF%E6%89%A7%E8%A1%8C%E4%B8%8B%E5%88%97%E5%91%BD%E4%BB%A4"><span class="nav-number">2.3.2.</span> <span class="nav-text">查看配置文件语法是否正确，可执行下列命令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DNS%E7%BC%93%E5%AD%98%E8%AE%BE%E7%BD%AE"><span class="nav-number">2.3.3.</span> <span class="nav-text">DNS缓存设置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%89%E4%B8%AA%E4%BB%A5%E4%B8%8A%E5%9F%9F%E5%90%8D%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="nav-number">2.3.4.</span> <span class="nav-text">三个以上域名服务器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8dhcpcd"><span class="nav-number">2.3.5.</span> <span class="nav-text">使用dhcpcd</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8dhclient"><span class="nav-number">2.3.6.</span> <span class="nav-text">使用dhclient</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8NetworkManager"><span class="nav-number">2.3.7.</span> <span class="nav-text">使用NetworkManager</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DHCP%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AE%BE%E7%BD%AE"><span class="nav-number">2.3.8.</span> <span class="nav-text">DHCP服务器设置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E8%87%AA%E5%AE%9A%E4%B9%89%E5%9F%9F"><span class="nav-number">2.3.9.</span> <span class="nav-text">添加自定义域</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B"><span class="nav-number">2.3.10.</span> <span class="nav-text">启动守护进程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#dnsmasq%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-etc-dnsmasq-conf%E8%AF%A6%E8%A7%A3"><span class="nav-number">2.4.</span> <span class="nav-text">dnsmasq的配置文件&#x2F;etc&#x2F;dnsmasq.conf详解</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Tiki"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Tiki</p>
  <div class="site-description" itemprop="description">个人技术博客</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">38</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">33</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://zhangzr.com/2018/09/04/DD-WRT/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Tiki">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="大象无形，大音希声">
      <meta itemprop="description" content="个人技术博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="DD-WRT安装与配置 | 大象无形，大音希声">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          DD-WRT安装与配置
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-09-04 00:17:53" itemprop="dateCreated datePublished" datetime="2018-09-04T00:17:53+08:00">2018-09-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2021-11-25 10:45:58" itemprop="dateModified" datetime="2021-11-25T10:45:58+08:00">2021-11-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF%E7%A7%AF%E7%B4%AF/" itemprop="url" rel="index"><span itemprop="name">技术积累</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="DD-WRT配置"><a href="#DD-WRT配置" class="headerlink" title="DD-WRT配置"></a>DD-WRT配置</h1><span id="more"></span>

<h2 id="nvram命令"><a href="#nvram命令" class="headerlink" title="nvram命令"></a>nvram命令</h2><p>nvram具有多层含义。首先它是非可变性RAM（non-volatile RAM）的缩写，这种RAM是一种持久性内存，可在断电时保留数据。路由器内的闪存就是一种nvram。nvram命令用于管理硬件设置，这些设置保存在闪存的最后一块内。这个内存段通常称为“nvram”。nvram命令有不同版本，比如IBM、Cisco、Oracle和Apple版。DD-WRT内的nvram命令非常简单，因为它只是显示和更改分配给变量的颠倒以及删除变量。无选项情况下运行它可以看到选项和参数：</p>
<figure class="highlight plaintext"><figcaption><span>ash shell</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@linksys:~# nvram</span><br><span class="line">usage: nvram [get name] [set name=value] [unset name] [show]</span><br></pre></td></tr></table></figure>
<p>nvram show显示了路由器上的所有设置，而且设置还不少。可以使用less将其分隔为一次一页：</p>
<figure class="highlight plaintext"><figcaption><span>ash shell</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@linksys:~# nvram show | less</span><br></pre></td></tr></table></figure>
<p>或是用grep查找特定的变量，比如：</p>
<figure class="highlight plaintext"><figcaption><span>ash shell</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@linksys:~# nvram show | grep ssh</span><br></pre></td></tr></table></figure>
<p>例如：如果你无意间禁用了WEB界面，但仍有telnet或SSH，可以以这种方式重新启用它：</p>
<figure class="highlight plaintext"><figcaption><span>ash shell</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@linksys:~# nvram set hhtp_enable=1</span><br><span class="line">root@linksys:~# nvram commit</span><br><span class="line">root@linksys:~# reboot </span><br></pre></td></tr></table></figure>
<p>如果想清除任何值的变量可参考如下所示：</p>
<figure class="highlight plaintext"><figcaption><span>ash shell</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@linksys:~# nvram set http_enable=&quot;&quot;</span><br><span class="line">root@linksys:~# nvram commit</span><br></pre></td></tr></table></figure>
<h2 id="JFFS-Journalling-Flash-File-System"><a href="#JFFS-Journalling-Flash-File-System" class="headerlink" title="JFFS(Journalling Flash File System)"></a>JFFS(Journalling Flash File System)</h2><p>通常，DD-WRT映像会占据约26MB分区，即便闪存是128MB或更多，也是如此。可以在未使用的空间创建另一个分区并用其来存储文件。这应该主要是读存储（read-storage）,比如无线热点splash和配置页、WEB页、额外的配置文件以及面向ipkg（针对嵌入式设备的ItsyPackage Management System）的存储空间。不要将它用于像日志文件这样能生成大量写操作的文件，因为闪存只支持数量有限的写操作并最终会出现故障。现代的闪存相当耐用，但它仍具有有限的写操作生命期限。用这个很好的旧df命令可以看到现有的文件系统：<br><img src="/dd-wrt_1.png" alt="Alt text" title="Optional title"></p>
<p>我的路由器具有128MB闪存，那么剩下的那些去哪了呢？它闲置在哪，等着被派上用场。访问Administrator–&gt;Management并检查JFFS2–&gt;Enable和Clean JFFS2–&gt;Enable。单击Apple Setting，继而Reboot Router。当它重启时，应该会看到类似下面的结果：<br><img src="/dd-wrt_2.png" alt="Alt text" title="Optional title"></p>
<p>JFFS2（Journalling Flash File System 版本2）是针对闪存存储媒介设计的。我们先来看看这种闪存属于哪种媒介。它是一种特殊的设备，称为Memory Technology Device，缩写为MTD。它不是一种像硬盘和USB棒那样的块设备，也不是像键盘鼠标那样的字符设备。块设备通常以大小固定（512和1024字节）的分区组织而成。而MTD则具有大小为128KB和更大的擦写块（eraseblock）。块设备可以做两件事：读区和写区。MTD可以做三件事：从擦写块读、写到擦写块和擦除擦写块。</p>
<p>紧凑式闪存、SD 卡、USB 棒究其本质都是 MTD。但它们对于操作系统而言更像是块设备，因为它们具有 Flash Translation Layers (FTL)，用于在闪存硬件之上模拟块设备。这种 FTL 可以位于主计算机上，也可以位于此设备内的硬件控制器的固件上。如果您愿意牺牲一个 USB 棒（为知识的进步所做的一次伟大的牺牲）并撬开它，那么您很有可能会看到一些 NAND 芯片（原始的闪存芯片）和一个微控制器。</p>
<p>了解有关闪存的几件事情将有助于您的 DD-WRT 探险之旅。第一，NAND 擦写块显示的是全或无（整个块必须在新的数据写上之前先被擦除）。第二，Linux 具有一个 MTD 子系统，和一个用来执行基本任务（比如擦除或向设备写映像）的 mtd 命令。可以在 DD-WRT 上运行无选项的 mtd 命令来查看语法和选项。在 DD-WRT 维基上还可以看到一些关于如何使用 mtd 命令的 how-to 文章，现在您该知道它是怎么回事了吧。第三，nvram 位于最后一个擦写块上，而无论擦写块有多大，它都被以编程的方式限制为 32KB。</p>
<h3 id="使用WEB-GUI界面启用JFFS"><a href="#使用WEB-GUI界面启用JFFS" class="headerlink" title="使用WEB GUI界面启用JFFS"></a>使用WEB GUI界面启用JFFS</h3><p>通过路由器网页启用JFFS的步骤非常具体。为了避免重置和重新编程路由器，设置备份是明智之举。通过以下步骤在DD-WRT中启用JFFS</p>
<ol>
<li>路由器的主页中点击“管理”</li>
<li>向下滚动，直到看到JFFS2支持部分</li>
<li>点击“启动JFFS“</li>
<li>点击“保存”</li>
<li>等待几秒钟，然后单击“应用”</li>
<li>再等一下，返回到启用JFFS部分，并启用“Clean JFFS”</li>
<li>不要点击“保存”。单击“应用”，这时路由器将如上面介绍的对空间进行格式化</li>
<li>等到网络的GUI界面回来，然后禁用“clean JFFS”，单击“保存”</li>
<li>重新启动一下路由器</li>
</ol>
<h3 id="命令行方式启动JFFS：CLI"><a href="#命令行方式启动JFFS：CLI" class="headerlink" title="命令行方式启动JFFS：CLI"></a>命令行方式启动JFFS：CLI</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">nvram set jffs_mounted=1</span><br><span class="line">nvram set enable_jffs2=1</span><br><span class="line">nvram set sys_enable_jff2=1</span><br><span class="line">nvram set clean_jffs=1</span><br><span class="line">nvram set sys_clean_jffs2=1</span><br><span class="line">nvram commit</span><br><span class="line">reboot</span><br><span class="line"># 删除变量请使用如下命令</span><br><span class="line"># nvram unset &lt;variable&gt;</span><br></pre></td></tr></table></figure>

<h3 id="增加JFFS空间的方法"><a href="#增加JFFS空间的方法" class="headerlink" title="增加JFFS空间的方法"></a>增加JFFS空间的方法</h3><h4 id="增加1G闪存卡"><a href="#增加1G闪存卡" class="headerlink" title="增加1G闪存卡"></a>增加1G闪存卡</h4><p>加入到SD&#x2F;MMC模式</p>
<ul>
<li>DD-WRT V2.4或更高版本才支持1G闪存</li>
<li>创建文件夹<code>mkdir /mmc/jffs</code></li>
<li>绑定设备到上面文件夹<code>mount --bind /mmc/jffs /jffs</code></li>
<li>进入GUI界面“管理–&gt;JFFS2启用” 或者使用CLI命令行<code>nvram set sys_enable_jffs2=1</code></li>
<li>创建文件夹得以使用ipkg<code>mkdir /jffs/tmp &amp;&amp; mkdir /jffs/tmp/ipkg</code></li>
</ul>
<h4 id="添加USB存储设备"><a href="#添加USB存储设备" class="headerlink" title="添加USB存储设备"></a>添加USB存储设备</h4><ul>
<li>首先，要启用USB设备的支持，安装USB驱动，并启动jffs<figure class="highlight plaintext"><figcaption><span>ash shell</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mount /dev/scsi/hosts0/bus0/target0/lun0/part1 /mnt</span><br><span class="line">mkdir /mnt/jhffs</span><br><span class="line">mount /mnt/jffs /jffs</span><br></pre></td></tr></table></figure></li>
<li>进入GUI界面“管理–&gt;JFFS2启用” 或者使用CLI命令行<code>nvram set sys_enable_jffs2=1</code></li>
<li>创建文件夹得以使用ipkg<code>mkdir /jffs/tmp &amp;&amp; mkdir /jffs/tmp/ipkg</code></li>
</ul>
<h4 id="测试ipkg"><a href="#测试ipkg" class="headerlink" title="测试ipkg"></a>测试ipkg</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd /jffs</span><br><span class="line">mkdir -p /jffs/tmp/ipkg</span><br><span class="line">ipkg update</span><br><span class="line">ipkg list</span><br></pre></td></tr></table></figure>

<div class="note danger"><p>建议运行上述命令后重启路由器</p>
</div>


<h2 id="Entware安装与配置"><a href="#Entware安装与配置" class="headerlink" title="Entware安装与配置"></a>Entware安装与配置</h2><h3 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h3><p>Entware是什么？它是嵌入式设备的软件存储库，如路由器或网络附加存储，库中大约有2000个以上的可用程序包。它本身是Optware的替代品。在五年的发展中Entware成了主流，在X86、X64、MIPS、MIPSEL、ARMV5和ARMV7平台有有着很好的应用，并且目前有专门的团队进行维护。</p>
<h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><ol>
<li>登录到路由器的GUI界面，服务–&gt;USB，确保核心USB支持、USB存储和自动驱动器安装都已经启用。如果一个或多个没有启用，那么请启用它并单击“应用”使之生效。</li>
<li>重新分区格式化USB相关设备，确保USB设备的分区格式为Ext2或者是Ext3或NTFS。如果它是硬盘驱动器，分区时要设置为主分区，不要设置逻辑分区。如果你希望EntWare自动安装到相关分区，那么请在此分区设置标签，标签值为“Optware”<br><img src="/USB_support.jpg" alt="图片(DD-WRT USB设置)" title="USB设置"></li>
</ol>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><ol>
<li>在路由器中插入USB设备，可能需要重新启动路由器。检查服务-USB，看看它是否出现，记下当前的挂载点<code>/tmp/mnt/sda_part1</code>，如果正确这里应为<code>/tmp/mnt/opt</code></li>
<li>打开SSH终端到路由器。使用上面的挂载点链入以下命令<figure class="highlight plaintext"><figcaption><span>ash shell</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cd /opt</span><br><span class="line">wget &#123;link to std install script for your router&#125; (click enter)</span><br><span class="line">sh generic.sh (click enter)</span><br><span class="line"># 我的路由器是EA6500，Broadcom单核，因此我使用如下地址：</span><br><span class="line">cd /opt</span><br><span class="line">wget http://bin.entware.net/mipselsf-k3.4/installer/generic.sh (click enter)</span><br><span class="line">sh generic.sh </span><br></pre></td></tr></table></figure></li>
<li>安装完成，运行更新<figure class="highlight plaintext"><figcaption><span>ash shell</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">opkg update (click enter)</span><br><span class="line">opkg upgrade (click enter)</span><br></pre></td></tr></table></figure></li>
<li>最后一步是将以下命令添加到启动脚本（管理–&gt;命令）。睡眠值可以调整，但对于大多数USB硬件&#x2F;路由器来说，10是足够长的。<figure class="highlight plaintext"><figcaption><span>ash shell</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sleep 10</span><br><span class="line">/opt/etc/init.d/rc.unslung start</span><br></pre></td></tr></table></figure>
<div class="note danger"><p>注意：</p>
<ul>
<li>不要向PATH或LD_LIBRARY_PATH变量添加任何内容，它们已经包括了必要的文件夹的位置；</li>
<li>安装完毕可以通过连接<code>http://bin.entware.net/mipselsf-k3.4/Packages.html</code>，查看全部包信息</li>
<li>你可以使用<code>opkg list</code>查看包列表</li>
</ul>
</div></li>
</ol>
<h3 id="DD-WRT固件升及对于Entware的影响"><a href="#DD-WRT固件升及对于Entware的影响" class="headerlink" title="DD-WRT固件升及对于Entware的影响"></a>DD-WRT固件升及对于Entware的影响</h3><p>在升级DD-WRT固件以前，最好删除Entware驱动或者禁用USB的支持。升级DD-WRT不会给Entware安装带来任何问题，只要开发人员不要更改上面提到的PATH或LD_LIBRARY_PATH变量。升级后只需再次启用USB支持即可。然后打开SSH终端并发出以下命令：</p>
<figure class="highlight plaintext"><figcaption><span>ash shell</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">opkg update</span><br><span class="line">opkg upgrade</span><br></pre></td></tr></table></figure>

<h3 id="EntWare-WiKi"><a href="#EntWare-WiKi" class="headerlink" title="EntWare WiKi"></a>EntWare WiKi</h3><p><a target="_blank" rel="noopener" href="https://github.com/Entware/Entware/wiki">Entware Wiki : https://github.com/Entware/Entware/wiki</a></p>
<h2 id="启动脚本"><a href="#启动脚本" class="headerlink" title="启动脚本"></a>启动脚本</h2><p>在DD-WRT中有三种方法让它们自动运行。</p>
<h3 id="在路由器上加载脚本的WEB界面方法"><a href="#在路由器上加载脚本的WEB界面方法" class="headerlink" title="在路由器上加载脚本的WEB界面方法"></a>在路由器上加载脚本的WEB界面方法</h3><p><br><span style="font-weight: bolder; font-size: 20px">1. 先决条件</span></p>
<ul>
<li>可以访问Web界面</li>
<li>知道启动时运行的命令</li>
<li>在命令行中测试命令以确保正确的操作</li>
</ul>
<p><br><span style="font-weight: bolder; font-size: 20px">2. 操作指南</span></p>
<ul>
<li>使用Web界面，转到管理选项卡</li>
<li>转到命令子选项卡</li>
<li>在命令对话框中键入希望运行每次启动命令（使用enter键将每个命令放在换行符上，如果该命令不是暂时停止运行的命令，则在命令后面加上“&amp;”）</li>
<li>如果希望将命令保存到rc_startup变量，请单击页面底部的“存储启动命令”按钮。保存防火墙将命令保存到RCI防火墙变量中。</li>
</ul>
<p><br><span style="font-weight: bolder; font-size: 20px">3. 工作原理</span><br>这样做是将您的命令串保存到闪存中的RCL启动变量（也称为NVRAM变量）。由于闪存在启动时不会被擦除，所以你的“startup script”将在每次启动时一直存在，并且总是执行。在命令框中单击“运行命令”按钮。</p>
<p><br><span style="font-weight: bolder; font-size: 20px">4. 定制脚本</span></p>
<ul>
<li>如果你的中由器一个保存自定义脚本按钮，你可以将命令保存在<code>/tmp/custom.sh</code></li>
<li>你可以通过在命令框中键入<code>sh /tmp/custom.sh</code>。追在一个“&amp;”符命令会把它放在后台：<code>sh /tmp/custom.sh &amp;</code></li>
</ul>
<h3 id="NVRAM方法"><a href="#NVRAM方法" class="headerlink" title="NVRAM方法"></a>NVRAM方法</h3><p><br><span style="font-weight: bolder; font-size: 20px">1. 先决条件</span></p>
<ul>
<li>用于登陆路由器工具telnet或SSH</li>
<li>了解每一次启动你想要运行的命令</li>
<li>测试运行命令（可选）</li>
</ul>
<p><br><span style="font-weight: bolder; font-size: 20px">2. 操作指南</span></p>
<ol>
<li>使用Telnet&#x2F;SSH登陆路由器</li>
<li>叵要设置启动脚本，请使用以下内容：<figure class="highlight plaintext"><figcaption><span>ash shell</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">nvram set rc_startup=&quot;</span><br><span class="line">&lt;command 1&gt;</span><br><span class="line">&lt;command 2&gt;</span><br><span class="line">...</span><br><span class="line">&lt;command n&gt;</span><br><span class="line">&quot;</span><br></pre></td></tr></table></figure>
提交NVRAM命令后，RCL启动变量保存在闪存中，在重新启动时将保留。<br><code>nvram commit</code></li>
</ol>
<p><br><span style="font-weight: bolder; font-size: 20px">3. 工作原理</span><br>当你发出第一个命令时，你注意到提示符更改为“&gt;”，从这里起，您键入的每一行都被添加到rc_startup变量中。从技术上讲，你仍然在同一个命令行上键入，即使你正在使用多行。当你键入最后一个双引号并点击回车键后，你将看到提示符更改返回，并且已经执行了第一个命令。也就是说，脚本已经添加到变量RCL启动中。<br>此时，你可以通过发出命令检查RCL启动的内容：<br><code>～# nvram get rc_startup</code></p>
<p><br><span style="font-weight: bolder; font-size: 20px">4. 自动化的WEB界面</span><br>为了自动化或测试Web界面，可以使用免费的<code>IMACROS Firefox</code>插件。您可以在Web界面中记录和重放你的活动，你可以下载它：<br><a target="_blank" rel="noopener" href="https://addons.mozilla.org/firefox/3863/">https://addons.mozilla.org/firefox/3863/</a></p>
<h3 id="Shell脚本方法"><a href="#Shell脚本方法" class="headerlink" title="Shell脚本方法"></a>Shell脚本方法</h3><p>简单的nvram脚本适合于短脚本，但是如果你想体大量的工作，或者如果你想轻松地管理启动程序，最好的方法就是使用shell脚本。</p>
<p>Shell脚本使编写长脚本变得更加容易，长脚本又可以从互联网上获取可执行文件或脚本，或安装<code>ipkg -d </code>内存安装，从闪存分区复制预制的配置文件等，然后才能最终运行程序，并在每次启动时都这样做。</p>
<p>这意味着你不必在路由器闪存空间（nvram，这是相当有限的）中保存那么多的东西，但是您可以替代地填充更流得的RAM，而不必在每次重新启动时手动重新安装和配置程序。</p>
<p>而且，由于每个程序都有自己的脚本，因此在下一次引导中删除程序就如同删除、移动或重命名启动脚本文件一样简单。</p>
<p><br><span style="font-weight: bolder; font-size: 20px">1. 先决条件</span></p>
<ul>
<li>使用telnet或ssh登陆路由器</li>
<li>了解你在启动时运行的命令</li>
<li>使用SCP、WinSCP或其他方法将文件复制到路由器上。</li>
<li>启用JFFS并正常工作。</li>
<li>编辑脚本</li>
<li>测试你的命令以确呆正确操作</li>
</ul>
<p><br><span style="font-weight: bolder; font-size: 20px">2. 编写Shell脚本</span><br>编写每个程序的shell脚本。脚本以后缀名“*.startup”的文件<br>shell脚本应该看起来像这样：</p>
<figure class="highlight plaintext"><figcaption><span>ash shell</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">&lt;command 1&gt;</span><br><span class="line">&lt;command 2&gt;</span><br><span class="line">&lt;command 3&gt;</span><br><span class="line">...</span><br><span class="line">killall &lt;command n program name&gt;</span><br><span class="line">&lt;command n&gt;</span><br></pre></td></tr></table></figure>
<p>由于DD-WRT系统的设计，你的shell脚本可能最终会定期运行，而不仅权是在引导时运行，这意味着，你需要确保每次只运行1次程序<command n>。</p>
<p>killall命令确保<command n>不同时运行不止一次。这假设在执行之后立即退出<command n>之前出现在脚本中的所有命令（例如cp、wget或iptables）</p>
<p>例如下面脚本举例：<code>kismet_server.startup</code></p>
<figure class="highlight plaintext"><figcaption><span>ash shell</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line"># Make the /tmp/usr/bin folder and move there</span><br><span class="line">mkdir /tmp/usr</span><br><span class="line">mkdir /tmp/usr/bin</span><br><span class="line">cd /tmp/usr/bin</span><br><span class="line"></span><br><span class="line">#copy the executable file from my home web server</span><br><span class="line">wget http://192.168.1.2/kismet_server</span><br><span class="line"></span><br><span class="line">#kill and previously-running instances of kismet_server</span><br><span class="line">killall -q kismet_server</span><br><span class="line"></span><br><span class="line">#execute kismet_server using /jffs/etc/kismet.conf as the configuration file.</span><br><span class="line">/tmp/usr/bin/kismet_server -n -f /jffs/etc/kismet.conf </span><br></pre></td></tr></table></figure>
<p><br><span style="font-weight: bolder; font-size: 20px">3. 保存脚本</span><br>在<code>/jffs/etc/config</code>目录中保存脚本。如果没有你可以创建此目录。<br><br><span style="font-weight: bolder; font-size: 20px">4. 使脚本可执行</span><br><code>~ # chmod 700 /jffs/etc/config/&lt;scriptname&gt;.startup</code></p>
<h3 id="配置脚本的不同目录"><a href="#配置脚本的不同目录" class="headerlink" title="配置脚本的不同目录"></a>配置脚本的不同目录</h3><ul>
<li><code>/etc/config/</code></li>
<li><code>/jffs/etc/config/</code></li>
<li><code>/mmc/etc/config/</code></li>
<li><code>/tmp/etc/config/</code></li>
</ul>
<table>
<thead>
<tr>
<th>后缀名</th>
<th>解释</th>
</tr>
</thead>
<tbody><tr>
<td><code>.startup</code></td>
<td>将在系统启动、正常启动时间和防火墙配置之前执行</td>
</tr>
<tr>
<td><code>.prewall</code></td>
<td>每当WAN接口up并在防火墙之前执行</td>
</tr>
<tr>
<td><code>.wanup</code></td>
<td>每当WAN接口up并在防火墙之后执行</td>
</tr>
<tr>
<td><code>.if</code></td>
<td>将在任何接口和防火墙之后执行（不再在源代码中，必须删除）</td>
</tr>
<tr>
<td><code>.ipup</code></td>
<td>当PPP连接在断开和防火墙之后重新建立时运行</td>
</tr>
<tr>
<td><code>.ipdown</code></td>
<td>当PPP连接被关闭时运行。（不再在源代码中，必须删除吗？）</td>
</tr>
<tr>
<td><code>.sesbutton</code></td>
<td>在按下“SES&#x2F;AOSS&#x2F;EZ-SETUP”按钮时执行</td>
</tr>
</tbody></table>
<p>注意：需要使用chmod命令更改脚本的执行权限。当脚本<code>.wanup</code>启动时，脚本可以运行多次。<br><a target="_blank" rel="noopener" href="http://www.dd-wrt.com/phpBB2/viewtopic.php?p=433984">参见：http://www.dd-wrt.com/phpBB2/viewtopic.php?p=433984</a></p>
<p><span style="font-weight: bolder; font-size: 20px">使用不同扩展名或不同文件夹执行脚本</span><br>如果要执行具有不同扩展名的脚本或位于其他文件夹中的脚本，可以创建此脚本。</p>
<figure class="highlight plaintext"><figcaption><span>ash shell</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">for I in &#x27;/bin/ls /jffs/etc/config/*.myextension&#x27;;do</span><br><span class="line">    sh $I &amp;</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<h3 id="举例：samba启动脚本"><a href="#举例：samba启动脚本" class="headerlink" title="举例：samba启动脚本"></a>举例：samba启动脚本</h3><p>在文件夹<code>/jffs/etc/config</code>下，建立名为<code>samba.startup</code>脚本</p>
<figure class="highlight plaintext"><figcaption><span>ash shell</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">/usr/sbin/smbd -D --configfile=/tmp/smb.conf</span><br><span class="line">/usr/sbin/nmbd -D --configfile=/tmp/smb.conf</span><br></pre></td></tr></table></figure>
<p>没有放在&#x2F;etc&#x2F;config下原因这个目录是read-only的<br>没有放在&#x2F;tmp&#x2F;etc&#x2F;config&#x2F;的原因为这个目录是临时的，重启之后这个目录里的东西就没了。</p>
<h3 id="举例：nginx启动脚本"><a href="#举例：nginx启动脚本" class="headerlink" title="举例：nginx启动脚本"></a>举例：nginx启动脚本</h3><p>假设你安装一个 nginx , 它会在 init.d 目录创建一个名为 S80nginx 的服务脚本（数字可能不一样）。配置上述的脚本以后它会开机启动。但是，如果手动操作这个服务脚本呢？只需要：<br><code>/opt/etc/init.d/S80nginx start|restart|stop</code><br>执行它，给它相应参数即可。<br>但是，这样做未免太麻烦了。因为不仅仅是 init.d 目录不在 PATH 中，而是每个服务由于优先级的原因命名很麻烦。如果想手动 启动&#x2F;停止&#x2F;重启 某个服务还需要记住它的数字，打上大写的 S 也很麻烦。总之，这种手动直接运行服务文件的方式很麻烦。于是，我为了方便管理服务写了一个 lua 脚本，它基于这些服务文件，可以像其他发型版中的 service 一样根据正常服务名称管理服务：</p>
<figure class="highlight plaintext"><figcaption><span>ash shell</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@DD-WRT:~# ser privoxy restart</span><br><span class="line"> Shutting down privoxy...              done. </span><br><span class="line"> Starting privoxy...              done. </span><br><span class="line">root@DD-WRT:~# </span><br></pre></td></tr></table></figure>
<p>可以看到， ser 管理服务不需要绝对路径，不需要服务文件名，而是以服务应该有的名字（S + 数字之后的部分）。我们在 &#x2F;opt&#x2F;bin 目录创建文件 ser :</p>
<figure class="highlight plaintext"><figcaption><span>ash shell</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env lua</span><br><span class="line">function os.capture(cmd, raw)</span><br><span class="line">    local f = assert(io.popen(cmd, &#x27;r&#x27;))</span><br><span class="line">    local s = assert(f:read(&#x27;*a&#x27;))</span><br><span class="line">    f:close()</span><br><span class="line">    if raw then return s end</span><br><span class="line">    return string.sub(s, 0, string.len(s) - 1)</span><br><span class="line">end</span><br><span class="line">PATH = &#x27;/opt/etc/init.d/&#x27;</span><br><span class="line">function handler(s_name, operation)</span><br><span class="line">    local out = os.capture(&#x27;ls &#x27; .. PATH, false)</span><br><span class="line">    local flag = false</span><br><span class="line">    for s in string.gmatch(out, &#x27;%S+&#x27;) do</span><br><span class="line">        local prefix = string.match(s, &#x27;^S%d+&#x27;)</span><br><span class="line">        if prefix then</span><br><span class="line">            local service_name = string.sub(s, string.len(prefix) + 1)</span><br><span class="line">            if service_name == s_name then</span><br><span class="line">                print(os.capture(PATH .. s .. &#x27; &#x27; .. operation))</span><br><span class="line">                flag = true</span><br><span class="line">            end</span><br><span class="line">        end</span><br><span class="line">    end</span><br><span class="line">    if not flag then</span><br><span class="line">        print(&#x27;No service: &#x27; .. s_name)</span><br><span class="line">    end</span><br><span class="line">end</span><br><span class="line">handler(arg[1], arg[2])</span><br></pre></td></tr></table></figure>
<p>添加执行权限：<code>chmod +x /opt/bin/ser</code><br>后就可以使用它了。当然，由于它是一个 lua 脚本，你需要安装 lua :<code>opkg install lua</code><br>这样子管理服务就方便得多了</p>
<h2 id="Entware安装应用设置开机启用"><a href="#Entware安装应用设置开机启用" class="headerlink" title="Entware安装应用设置开机启用"></a>Entware安装应用设置开机启用</h2><p>通过Entware安装的软件在 &#x2F;opt&#x2F;etc&#x2F;init.d 下生成了服务脚本，它仍然在开关机时不会得到执行。<br>我们可以基于 DD 提供的 ‘Commands’ 功能做到这一点：<br><br/><span style="font-weight: bolder; font-size: 20px">1. 创建相关目录（启用 jffs 的目的是用来存放这些固定的永久储存的东西）：</span></p>
<figure class="highlight plaintext"><figcaption><span>ash shell</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd /jffs </span><br><span class="line">mkdir scripts </span><br><span class="line">cd scripts</span><br><span class="line">mkdir shutdown</span><br><span class="line">mkdir startup</span><br></pre></td></tr></table></figure>
<p><br/><span style="font-weight: bolder; font-size: 20px">2. 在 scripts 目录创建 operator.sh 脚本（控制 shutdown 目录或者startup 目录的脚本执行）：</span></p>
<figure class="highlight plaintext"><figcaption><span>ash shell</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env sh</span><br><span class="line">SCRIPTS_HOME=/jffs/scripts</span><br><span class="line">run_all()&#123;</span><br><span class="line">    for SCRIPT in &quot;$SCRIPTS_HOME&quot;/&quot;$1&quot;/*;</span><br><span class="line">        do</span><br><span class="line">                if [ -f &quot;$SCRIPT&quot; -a -x &quot;$SCRIPT&quot; ]</span><br><span class="line">                then</span><br><span class="line">                        $SCRIPT</span><br><span class="line">                fi</span><br><span class="line">        done</span><br><span class="line">&#125;</span><br><span class="line">run_all &quot;$1&quot;</span><br></pre></td></tr></table></figure>
<p><br/><span style="font-weight: bolder; font-size: 20px">3. 在 startup 目录分别创建 S10service 和 S30swapon：</span></p>
<figure class="highlight plaintext"><figcaption><span>ash shell</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">RC=&#x27;/opt/etc/init.d/rc.unslung&#x27;</span><br><span class="line">i=30</span><br><span class="line">until [ -x &quot;$RC&quot; ] ; do</span><br><span class="line">  i=$(($i-1))</span><br><span class="line">  if [ &quot;$i&quot; -lt 1 ] ; then</span><br><span class="line">    logger &quot;Could not start Entware&quot;</span><br><span class="line">    exit</span><br><span class="line">  fi</span><br><span class="line">  sleep 1</span><br><span class="line">done</span><br><span class="line">$RC start</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><figcaption><span>ash shell</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line"># Turn On Usage Of Swapfile</span><br><span class="line">if [ -f &quot;/opt/swapfile&quot; ];then</span><br><span class="line">    swapon /opt/swapfile</span><br><span class="line">    echo &quot;Turning Swapfile On&quot;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
<p>它们分别是启动 init.d 中的服务和启用 swap （交换空间）的脚本。<br><br/><span style="font-weight: bolder; font-size: 20px">4. 设置开&#x2F;关机执行脚本</span><br>路由器 WEB UI -&gt; Tag: Administration - Commands , 分别添加以下两个命令，先后保存为 Startup 和 Shutdown ：<br><code>/jffs/scripts/operator.sh startup</code><br><code>/jffs/scripts/operator.sh shutdown</code><br>其实就是开机执行 operator.sh 脚本添加 startup 参数 和 关机执行 operator.sh 添加 shutdown 参数。而 operator.sh的流程其实就是遍历参数目录（例如 startup 和 shutdown）中所有的脚本并且依次执行。如果你看明白了，就会知道只要将脚本放进 startup 目录它就会开机执行，只要放进 shutdown 它就会关机时执行。<br><br>有关脚本执行顺序需要特意说明一下，这是我的目录结构：</p>
<figure class="highlight plaintext"><figcaption><span>ash shell</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@DD-WRT:/jffs/scripts# tree -L 3</span><br><span class="line">.</span><br><span class="line">|-- operator.sh</span><br><span class="line">|-- shutdown</span><br><span class="line">|   |-- S10service</span><br><span class="line">|   `-- S30swapoff</span><br><span class="line">`-- startup</span><br><span class="line">    |-- S10service</span><br><span class="line">    `-- S30swapon</span><br></pre></td></tr></table></figure>
<p>可以注意到，开机执行的脚本都是以 S + 数字 +名称来命名的。这样做的目的是方便遍历时排序，数字低的会被先遍历并执行，也就是根据命名做到了启动优先级。至于前缀的大写字母 S 可以用其他字母替代，但是要统一。是否后缀 .sh 也无所谓。其实这里我就是模仿的 init.d 里边的服务命名方式，因为它们就是用这种方式决定启动优先级的。这样做了以后，就在路由器固件原生不内置相关功能的情况下做到了一样的效果。安装的所有服务可以正常开机启动，并且可以自己添加任意的脚本让它们自动执行。（例如从上面的文件中可以看出来，我还在关机时运行了两个脚本）</p>
<h2 id="DNSMasq配置本地网络"><a href="#DNSMasq配置本地网络" class="headerlink" title="DNSMasq配置本地网络"></a>DNSMasq配置本地网络</h2><p><img src="/dd-wrt_3.png" alt="DD-WRT配置界面" title="dd-wrt配置"></p>
<h3 id="1-启动dnsmasq"><a href="#1-启动dnsmasq" class="headerlink" title="1. 启动dnsmasq"></a>1. 启动dnsmasq</h3><p>服务–&gt;服务–&gt;DNSMasq 启动</p>
<h3 id="2-启动本地DNS"><a href="#2-启动本地DNS" class="headerlink" title="2. 启动本地DNS"></a>2. 启动本地DNS</h3><p>服务–&gt;服务–&gt;本地DNS 启动</p>
<h3 id="3-DNSMasq-附加选项："><a href="#3-DNSMasq-附加选项：" class="headerlink" title="3. DNSMasq 附加选项："></a>3. DNSMasq 附加选项：</h3><p>dnsmasq会自动读取<code>/tmp/hosts</code>文件，重启后<code>/tmp</code>中的内容将会重置。因此建议开启jffs，并指定hosts，在Additional DNSMasq Options中填写</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">addn-hosts=/jffs/dnsmasq.hosts</span><br></pre></td></tr></table></figure>
<p>也可以设置不读取resolv.conf文件，直接在dnsmasq中设置dns服务器，在Additional DNSMasq Options中填写</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">no-resolv</span><br><span class="line">server=8.8.8.8</span><br><span class="line">server=8.8.4.4</span><br></pre></td></tr></table></figure>
<p>还可以将某个域名提交给指定的dns服务器解析，在Additional DNSMasq Options中填写</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">server=/.google.com/208.67.222.222#443</span><br><span class="line">server=/.google.com.hk/208.67.222.222#443</span><br></pre></td></tr></table></figure>
<p>如果Additional DNSMasq Options里的内容太多，也可指定一个目录来读取这些配置信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">conf-dir=/opt/etc/dnsmasq.d</span><br></pre></td></tr></table></figure>



<h1 id="dnsmasq详解及配置"><a href="#dnsmasq详解及配置" class="headerlink" title="dnsmasq详解及配置"></a>dnsmasq详解及配置</h1><p>Dnsmasq提供DNS缓存和DHCP服务功能。作为域名解析服务器（DNS），dnsmasq可以通过缓存DNS计法度来提高对访问过的网址的连接速度。作为DHCP服务器，dnsmasq可以用于为局域网电脑分配内网IP地址和提供路由。DNS和DHCP两个功能可以同时或分别单独实现。dnsmasq轻量且易配置，适用于个人用户或少于50台主机的网络，此外它还自带了一个PXE服务器。</p>
<h2 id="Dnsmasq的主要作用"><a href="#Dnsmasq的主要作用" class="headerlink" title="Dnsmasq的主要作用"></a>Dnsmasq的主要作用</h2><ol>
<li>将Dnsmasq作为本地DNS服务器使用，直接个改电脑的本地DNS的IP地址即可。</li>
<li>应对ISP的DNS劫持（反DNS劫持），输入一个不存在的域名，正常情况下浏览器是显示无法连接，DNS劫持会眺转到一个广告页面。先随便nslookup一个不存在的域名，看看ISP商劫持的IP地址</li>
<li>智能DNS加快解析速度，打开&#x2F;etc&#x2F;dnsmasq.conf文件，server&#x3D;后面添加指定DNS，例如国外不同网站使用不同的DNS<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 国内指定DNS</span><br><span class="line">server=/cn/114.114.114.114</span><br><span class="line">server=/taobao.com/114.114.114</span><br><span class="line">server=/taobaocdn.com/114.114.114</span><br><span class="line"># 国外指定DNS</span><br><span class="line">server=/google.com/8.8.8.8</span><br><span class="line">server=/youtube.com/8.8.8.8</span><br></pre></td></tr></table></figure></li>
<li>屏蔽网页广告，将指广告的URL指定127这个IP，就可以将网页上讨厌的广告去掉了。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">address=/ad.youku.com/127.0.0.1</span><br><span class="line">address=/ad.iqiyi.com/127.0.0.1</span><br></pre></td></tr></table></figure></li>
<li>指定域名解析到特定的IP上。这个功能可以让你控制一些网站的访问，非法的DNS就经常把一些正规的网站解析到不正确的IP上。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">address=/freehao123.com/123.123.123.123</span><br></pre></td></tr></table></figure></li>
<li>管理控制内网DNS，首先将局域网中的所有的设备的本地DNS设置为已经安装的Dnsmasq的服务器IP地址。然后修改已经安装Dnsmasq的服务器Hosts文件：<code>/etc/hosts</code>，指定域名琶特定的iP中。例如想让局域网的所有用户访问<a href="http://www.freehao123.com时跳转到192.168.0.2，添加：192.168.0.2">www.freehao123.com时跳转到192.168.0.2，添加：192.168.0.2</a> <a target="_blank" rel="noopener" href="http://www.freehao123.com在hosts文件中既可,整个过程也可以说是“dns劫持”./">www.freehao123.com在Hosts文件中既可，整个过程也可以说是“DNS劫持”。</a></li>
</ol>
<h2 id="Dnsmasq的解析流程"><a href="#Dnsmasq的解析流程" class="headerlink" title="Dnsmasq的解析流程"></a>Dnsmasq的解析流程</h2><p>dnsmasq先去解析hosts文件，再去解析&#x2F;etc&#x2F;dnsmasq.d&#x2F;下的*.conf文件，并且这些文件的优先级要高于dnsmasq.conf，我们自定义的resolv.dnsmasq.conf中的DNS也被称为上游DNS，这是最后去查询解析的；</p>
<p>如果不想用hosts文件做解析，我们可以在&#x2F;etc&#x2F;dnsmasq.conf中加入no-hosts这条语句，这样的话就直接查询上游DNS了，如果我们不想做上游查询，就是不想做正常的解析。我们就可以加入no-reslov这条语句。</p>
<h2 id="Dnsmasq的参数及常用设置说明"><a href="#Dnsmasq的参数及常用设置说明" class="headerlink" title="Dnsmasq的参数及常用设置说明"></a>Dnsmasq的参数及常用设置说明</h2><p>编辑dnsmasq的配置文件<code>/etc/dnsmasq.conf</code>。这个文件有大量的选项注释。</p>
<h3 id="经常修改的比较重要的参数说明"><a href="#经常修改的比较重要的参数说明" class="headerlink" title="经常修改的比较重要的参数说明"></a>经常修改的比较重要的参数说明</h3><table>
<thead>
<tr>
<th>具体参数</th>
<th>参数说明</th>
</tr>
</thead>
<tbody><tr>
<td>resolv-file</td>
<td>定义dnsmasq从哪里获取上游DNS服务器地址，默认从&#x2F;etc&#x2F;resolv.conf获取。</td>
</tr>
<tr>
<td>strict-order</td>
<td>表示严格按照resolv-file文件中的顺序从上到下进行DNS解析，直到第一个解析成功为止</td>
</tr>
<tr>
<td>listen-address</td>
<td>定义dnsmasq监听的地址，默认是监控本机的所有网卡上。</td>
</tr>
<tr>
<td>address</td>
<td>启用泛域名解析，即自定义解析a记录，例如：address&#x3D;&#x2F;long.com&#x2F;192.168.115.10访问long.com时的所有域名都会被解析成192.168.115.10</td>
</tr>
<tr>
<td>bogus-nxdomain</td>
<td>对于任何被解析到此的IP域名，将响应NXDOMAIN使其解析失效，可以多次指定。通常用于对于访问不存在的域名，禁止其跳转到运营商的广告站点</td>
</tr>
<tr>
<td>server</td>
<td>指定使用哪个DNS服务器进行解析，对不不同的网站可以使用不同的域名对应解析。例如：server&#x3D;&#x2F;google.com&#x2F;8.8.8.8 #表示对于google的服务，使用谷歌的DNS解析。</td>
</tr>
</tbody></table>
<h3 id="查看配置文件语法是否正确，可执行下列命令"><a href="#查看配置文件语法是否正确，可执行下列命令" class="headerlink" title="查看配置文件语法是否正确，可执行下列命令"></a>查看配置文件语法是否正确，可执行下列命令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost~]# dnsmasq --test</span><br><span class="line">dnsmasq: syntax check OK.</span><br></pre></td></tr></table></figure>

<h3 id="DNS缓存设置"><a href="#DNS缓存设置" class="headerlink" title="DNS缓存设置"></a>DNS缓存设置</h3><p>要在单台电脑上以守护进程方式启动dnsmasq做DNS缓存服务器，编辑&#x2F;etc&#x2F;dnsmasq.conf，添加监听地址：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">listen-address=127.0.0.1</span><br></pre></td></tr></table></figure>
<p>如果用此主机为局域网提供默认DNS，请为该主机绑定固定IP地址，设置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">listen-address=192.168.x.x</span><br></pre></td></tr></table></figure>
<p>多个IP地址设置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">listen-address=127.0.0.1, 192.168.x.x</span><br></pre></td></tr></table></figure>

<h3 id="三个以上域名服务器"><a href="#三个以上域名服务器" class="headerlink" title="三个以上域名服务器"></a>三个以上域名服务器</h3><p>linux处理DNS请求时有个限制，在resolv.conf中最多只能配置三个域名服务器（nameserver）。作为一种变通方法，可以在resolv.conf文件中只保留localhost作为域名服务器，然后为外部域名服务器另外创建resolv-file文件。首先，为dnsmasq新建一个域名解析文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost~]# vim /etc/resolv.dnsmasq.conf</span><br><span class="line"># Google&#x27;s nameservers, for example</span><br><span class="line">nameserver 8.8.8.8</span><br><span class="line">nameserver 8.8.4.4</span><br></pre></td></tr></table></figure>
<p>然后编辑&#x2F;etc&#x2F;dnsmasq.conf让dnsmasq使用新创建的域名解析文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost~]# vim /etc/dnsmasq.conf</span><br><span class="line">...</span><br><span class="line">resolv-file=/etc/resolv.dnsmasq.conf</span><br></pre></td></tr></table></figure>

<h3 id="使用dhcpcd"><a href="#使用dhcpcd" class="headerlink" title="使用dhcpcd"></a>使用dhcpcd</h3><p>dhcpcd可以通过创建（或编辑）<code>/etc/resolv.conf.head</code>文件或<code>/etc/resolv.conf.tail</code>文件来指定dns服务器，使<code>/etc/resolv.conf</code>不会被每次都被dhcpcd重写。<br><code>echo &quot;nameserver 127.0.0.1&quot; &gt; /etc/resolv.conf.head  设置dns服务器为127.0.0.1</code></p>
<h3 id="使用dhclient"><a href="#使用dhclient" class="headerlink" title="使用dhclient"></a>使用dhclient</h3><p>要使用dhclient，取消<code>/etc/dhclient.conf</code>文件中如下行的注释：<br><code>prepend domain-name-servers 127.0.0.1;</code></p>
<h3 id="使用NetworkManager"><a href="#使用NetworkManager" class="headerlink" title="使用NetworkManager"></a>使用NetworkManager</h3><p>NetworkManager可以靠自身配置文件的设置项启动dnsmasq。在NetworkManager.conf文件的[main]节段添加<code>dns=dnsmasq</code>配置语句，然后禁用由systemd启动的dnsmasq.service:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># vim /etc/NetworkManager/NetworkManager.conf</span></span><br><span class="line">[main]</span><br><span class="line">plugins=keyfile</span><br><span class="line">dns=dnsmasq</span><br></pre></td></tr></table></figure>
<p>可以在<code>/etc/NetworkManager/dnsmasq.d/</code>目录下为dnsmasq创建自定义配置文件。例如，调整DNS缓存大小（保存在内存中）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost~]# vim /etc/NetworkManager/dnsmasq.d/cache</span><br><span class="line">cache-size=1000</span><br></pre></td></tr></table></figure>
<p>dnsmasq 被 NetworkManager 启动后，此目录下配置文件中的配置将取代默认配置。</p>
<p>IPv6</p>
<p>启用 dnsmasq 在 NetworkManager 可能会中断仅持IPv6的DNS查询 (例如 dig -6 [hostname]) 否则将工作。 为了解决这个问题，创建以下文件将配置 dnsmasq 总是监听IPv6的loopback：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# vim /etc/NetworkManager/dnsmasq.d/ipv6_listen.conf</span><br><span class="line">listen-address=::1</span><br></pre></td></tr></table></figure>
<p>此外， dnsmasq不优先考虑上游IPv6的DNS。不幸的是NetworkManager已不这样做 (Ubuntu Bug)。 一种解决方法是将禁用IPv4 DNS的NetworkManager的配置，假设存在。</p>
<p>其他方式</p>
<p>另一种选择是在NetworkManagers“设置（通常通过右键单击小程序）和手动输入设置。设置将取决于前端中使用的类型;这个过程通常涉及右击小程序，编辑（或创建）一个配置文件，然后选择DHCP类型为“自动（指定地址）。”DNS地址将需要输入，通常以这种形式：127.0.0.1, DNS-server-one, ….</p>
<h3 id="DHCP服务器设置"><a href="#DHCP服务器设置" class="headerlink" title="DHCP服务器设置"></a>DHCP服务器设置</h3><p>dnsmasq默认关闭DHCP功能，如果该主机需要为局域网中的其他设备提供IP和中由，应该对dnsmasq配置文件（<code>/etc/dnsmasq.conf</code>）必要的配置如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost~]# vim /etc/dnsmasq.conf</span><br><span class="line"># Only listen to routers&#x27; LAN NIC. Doning so opens up tcp/udp port 53 to</span><br><span class="line"># localhost and udp port 67 to world:</span><br><span class="line"></span><br><span class="line">interface=&lt;LAN-NIC&gt;</span><br><span class="line"># dnsmasq will open tcp/upd port 53 and udp port 67 to world to help with</span><br><span class="line"># dynamic interfaces (assigning dynamic ips). Dnsmasq will discard world</span><br><span class="line"># requests to them, but the parranoid might like to close them and let the</span><br><span class="line"># kernel handle them:</span><br><span class="line">bind-interfaces</span><br><span class="line"></span><br><span class="line"># Dynamic range of IPs to make available to LAN pc</span><br><span class="line">dhcp-range=192.168.111.50,192.168.111.100,12h</span><br><span class="line"></span><br><span class="line"># if you&#x27;d like to have dnsmasq assign static IPs, bind the LAN computer&#x27;s</span><br><span class="line"># NIC MAC address:</span><br><span class="line">dhcp-host=aa:bb:cc:dd:ee:ff,192.168.111.50</span><br></pre></td></tr></table></figure>
<p>查看租约</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost~]# cat /var/lib/misc/dnsmasq.leases</span><br></pre></td></tr></table></figure>

<h3 id="添加自定义域"><a href="#添加自定义域" class="headerlink" title="添加自定义域"></a>添加自定义域</h3><p>它可以将一个自定义域添加到主机中的（本地）网络：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">local=/home.lan/</span><br><span class="line">domain=home.lan</span><br></pre></td></tr></table></figure>

<h3 id="启动守护进程"><a href="#启动守护进程" class="headerlink" title="启动守护进程"></a>启动守护进程</h3><p>设置开机启动：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost~]# systemctl enable dnsmasq</span><br></pre></td></tr></table></figure>
<p>立即启动dnsmasq：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost~]# systemctl start dnsmasq</span><br></pre></td></tr></table></figure>
<p>需要重启网络服务以使DHCP客户端重建一个新的&#x2F;etc&#x2F;resolv.conf，查看dnsmasq是否启动正常，查看系统日志：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost~]# joumalctl -u d</span><br></pre></td></tr></table></figure>

<h2 id="dnsmasq的配置文件-etc-dnsmasq-conf详解"><a href="#dnsmasq的配置文件-etc-dnsmasq-conf详解" class="headerlink" title="dnsmasq的配置文件/etc/dnsmasq.conf详解"></a>dnsmasq的配置文件<code>/etc/dnsmasq.conf</code>详解</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br></pre></td><td class="code"><pre><span class="line"># 不加载本地的/etc/hosts文件</span><br><span class="line">#no-hosts</span><br><span class="line"># 添加读取额外的hosts文件路径，可以多次指定。如果指定为目录，则读取目录中的所有文件。</span><br><span class="line">#addn-hosts=/etc/dnsmasq.hosts.d</span><br><span class="line"># 读取目录中的所有文件，文件更新将自动读取</span><br><span class="line">#hostsdir=/etc/dnsmasq.hosts.d</span><br><span class="line"># 例如，/etc/hosts中的os01将扩展成os01.example.com</span><br><span class="line">#expand-hosts</span><br><span class="line"></span><br><span class="line"># 缓存时间设置，一般不需要设置</span><br><span class="line"># 本地hosts文件的缓存时间，通常不要求缓存本地，这样更改hosts文件后就即时生效</span><br><span class="line">#local-ttl=3600</span><br><span class="line"># 同local-ttl仅影响DHCP租约</span><br><span class="line">#dhcp-ttl=&lt;time&gt;</span><br><span class="line"># 对于上游返回的值没有ttl时，dnsmasq给一个默认的ttl，一般不需要设置</span><br><span class="line">#neg-ttl=&lt;time&gt;</span><br><span class="line"># 指定返回给客户端的ttl时间，一般不需要设置</span><br><span class="line">#max-ttl=&lt;time&gt;</span><br><span class="line"># 设置在缓存中的条目的最大TTL</span><br><span class="line">#max-cache-ttl=&lt;time&gt;</span><br><span class="line"># 不需要设置，除非你知道你在做什么</span><br><span class="line">#min-cache-ttl=&lt;time&gt;</span><br><span class="line"># 一般不需要设置</span><br><span class="line">#auth-ttl=&lt;time&gt;</span><br><span class="line"></span><br><span class="line"># 记录dns查询日志，如果指定log-queries=extra那么在每行开始处都有额外的日志信息</span><br><span class="line">#log-queries</span><br><span class="line"># 设置日志记录器，&#x27;-&#x27;为stderr，也可以是文件路径。默认为：DAEMON，调试时使用LOCAL0</span><br><span class="line">#log-facility=&lt;facility&gt;</span><br><span class="line">#log-facility=/var/log/dnsmasq/dnsmasq.log</span><br><span class="line"># 异步log，缓解阻塞，提高性能。默认为5，最大100</span><br><span class="line">#log-async[=&lt;lines&gt;]</span><br><span class="line">#log-async=50</span><br><span class="line"></span><br><span class="line">#指定用户和组</span><br><span class="line">#user=nobody</span><br><span class="line">#group=nobody</span><br><span class="line"></span><br><span class="line"># 指定DNS的端口，默认53，设置port=0将完全禁用DNS功能，仅使用DHCP/TFTP</span><br><span class="line">#port=53</span><br><span class="line"># 指定EDNS.0 UDP包的最大尺寸，默认是随机端口，指定后降低安全性、加快速度、减少资源消耗</span><br><span class="line"># 设置为&#x27;0&#x27;由操作系统分配。</span><br><span class="line">#query-port=53535</span><br><span class="line"># 指定向上游查询的UDP的端口范围，方便防火墙设置。</span><br><span class="line">#min-port=&lt;port&gt;</span><br><span class="line">#max-port=&lt;port&gt;</span><br><span class="line"># 指定接口，指定后同时附加lo接口，可以使用&#x27;*&#x27;通配符</span><br><span class="line"># 不能使用接口别名（例好：“eth1:0”），请用listen-address选项替代</span><br><span class="line">#interface=wlp2s0</span><br><span class="line"># 指定排除的接口，排除优先级高，可以使用“*”通配符</span><br><span class="line">#except-interface=</span><br><span class="line"># 仅接受同一子网的DNS请求。</span><br><span class="line"># 仅在未指定interface、excet-interface、listen-address或者auth-server时有效</span><br><span class="line">#local-service</span><br><span class="line"># 指定不提供DHCP或TFTP服务的接口，仅提供DNS服务。</span><br><span class="line">#no-dhcp-interface=enp3s0</span><br><span class="line"># 指定IP地址，可以多次指定</span><br><span class="line"># interface选项和listen-address选项可以同时使用。</span><br><span class="line"># 下面两行与指定interface选项的作用类似。</span><br><span class="line">listen-address=192.168.10.17</span><br><span class="line">#listen-address=127.0.0.1</span><br><span class="line"># 通常情况下即使设置了interface选项（例如：interface=wlp2s0）</span><br><span class="line"># 将仍然绑定到通配符地址（例如：*:53）</span><br><span class="line"># 开启此项将仅监听指定的接口</span><br><span class="line"># 适用于在同一主机的不同接口或IP地址上运行多个dns服务器</span><br><span class="line">bind-interfaces</span><br><span class="line"># 对于新添加的接口不进行绑定。仅linux系统支持，其他系统等同于bind-interfaces选项</span><br><span class="line">#bind-dynamic</span><br><span class="line"></span><br><span class="line">##############################################################################</span><br><span class="line"># 如果 hosts 中的主机有多个 IP 地址，仅返回对应子网的 IP 地址。</span><br><span class="line">localise-queries</span><br><span class="line"># 如果反向查找的是私有地址例如192.168.X.X，仅从 hosts 文件查找，不再转发到上游服务器</span><br><span class="line">#bogus-priv</span><br><span class="line"># 对于任何被解析到此 IP 的域名，将响应 NXDOMAIN 使其解析失效，可以多次指定</span><br><span class="line"># 通常用于对于访问不存在的域名，禁止其跳转到运营商的广告站点。</span><br><span class="line">#bogus-nxdomain=64.94.110.11</span><br><span class="line"># 忽略包含指定地址的 A 记录查询的回复。</span><br><span class="line"># 例如上游有台 dns 服务器伪造 www.baidu.com 的 IP 为 1.1.1.1 并且响应速度非常快。</span><br><span class="line"># 指定 ignore-address=1.1.1.1 可以忽略它的响应信息，</span><br><span class="line"># 从而等待 www.baidu.com 正确的查询结果。</span><br><span class="line">#ignore-address=&lt;ipaddr&gt;</span><br><span class="line">filterwin2k</span><br><span class="line"></span><br><span class="line">#############################################################################</span><br><span class="line"># 指定 resolv-file 文件路径，默认/etc/resolv.conf</span><br><span class="line">#resolv-file=/etc/resolv.conf</span><br><span class="line"># 不读取 resolv-file 来确定上游服务器</span><br><span class="line">#no-resolv</span><br><span class="line"># 在编译时需要启用 DBus 支持。</span><br><span class="line">#enable-dbus[=&lt;service-name&gt;]</span><br><span class="line"># 严格按照resolv.conf中的顺序进行查找</span><br><span class="line">#strict-order</span><br><span class="line"># 向所有上游服务器发送查询，而不是一个。</span><br><span class="line">all-servers</span><br><span class="line"># 启用转发循环检测</span><br><span class="line">#dns-loop-detect</span><br><span class="line"></span><br><span class="line">##############################################################################</span><br><span class="line"># 这项安全设置是拒绝解析包含私有 IP 地址的域名，</span><br><span class="line"># 这些IP地址包括如下私有地址范围：10.0.0.0/8、172.16.0.0/12、192.168.0.0/16。</span><br><span class="line"># 其初衷是要防止类似上游DNS服务器故意将某些域名解析成特定私有内网IP而劫持用户这样的安全攻击。</span><br><span class="line"># 直接在配置文件中注销 stop-dns-rebind 配置项从而禁用该功能。</span><br><span class="line"># 这个方法确实可以一劳永逸的解决解析内网 IP 地址的问题，</span><br><span class="line"># 但是我们也失去了这项安全保护的特性，所以在这里我不推荐这个办法。</span><br><span class="line"># 使用 rebind-domain-ok 进行特定配置，顾名思义该配置项可以有选择的忽略域名的 rebind 行为</span><br><span class="line">stop-dns-rebind</span><br><span class="line">rebind-localhost-ok</span><br><span class="line">#rebind-domain-ok=[&lt;domain&gt;]|[[/&lt;domain&gt;/[&lt;domain&gt;/]</span><br><span class="line">rebind-domain-ok=/.test.com/</span><br><span class="line">##############################################################################</span><br><span class="line"></span><br><span class="line"># 也不要检测 /etc/resolv.conf 的变化</span><br><span class="line">#no-poll</span><br><span class="line"># 重启后清空缓存</span><br><span class="line">clear-on-reload</span><br><span class="line"># 完整的域名才向上游服务器查找，如果仅仅是主机名仅查找hosts文件</span><br><span class="line">domain-needed</span><br><span class="line"></span><br><span class="line">##############################################################################</span><br><span class="line"></span><br><span class="line"># IP地址转换</span><br><span class="line">#alias=[&lt;old-ip&gt;]|[&lt;start-ip&gt;-&lt;end-ip&gt;],&lt;new-ip&gt;[,&lt;mask&gt;]</span><br><span class="line"></span><br><span class="line">##############################################################################</span><br><span class="line"></span><br><span class="line">#local=[/[&lt;domain&gt;]/[domain/]][&lt;ipaddr&gt;[#&lt;port&gt;][@&lt;source-ip&gt;|&lt;interface&gt;[#&lt;port&gt;]]</span><br><span class="line">#server=[/[&lt;domain&gt;]/[domain/]][&lt;ipaddr&gt;[#&lt;port&gt;][@&lt;source-ip&gt;|&lt;interface&gt;[#&lt;port&gt;]]</span><br><span class="line">server=/test.com/192.168.10.117</span><br><span class="line">server=/10.168.192.in-addr.arpa/192.168.10.117</span><br><span class="line">#rev-server=&lt;ip-address&gt;/&lt;prefix-len&gt;,&lt;ipaddr&gt;[#&lt;port&gt;][@&lt;source-ip&gt;|&lt;interface&gt;[#&lt;port&gt;]]</span><br><span class="line"># 将任何属于 &lt;domain&gt; 域名解析成指定的 &lt;ipaddr&gt; 地址。</span><br><span class="line"># 也就是将 &lt;domain&gt; 及其所有子域名解析成指定的 &lt;ipaddr&gt; IPv4 或者 IPv6 地址，通常用于屏蔽特定的域名。</span><br><span class="line"># 一次只能指定一个 IPv4 或者 IPv6 地址，要同时返回 IPv4 和IPv6 地址，请多次指定 address= 选项。</span><br><span class="line"># 注意： /etc/hosts 以及 DHCP 租约将覆盖此项设置。</span><br><span class="line">#address=/&lt;domain&gt;/[domain/][&lt;ipaddr&gt;]</span><br><span class="line">#ipset=/&lt;domain&gt;/[domain/]&lt;ipset&gt;[,&lt;ipset&gt;]</span><br><span class="line">#mx-host=&lt;mx name&gt;[[,&lt;hostname&gt;],&lt;preference&gt;]</span><br><span class="line">#mx-target=&lt;hostname&gt;</span><br><span class="line"># SRV 记录</span><br><span class="line">#srv-host=&lt;_service&gt;.&lt;_prot&gt;.[&lt;domain&gt;],[&lt;target&gt;[,&lt;port&gt;[,&lt;priority&gt;[,&lt;weight&gt;]]]]</span><br><span class="line"># A, AAAA 和 PTR 记录 </span><br><span class="line">#host-record=&lt;name&gt;[,&lt;name&gt;....],[&lt;IPv4-address&gt;],[&lt;IPv6-address&gt;][,&lt;TTL&gt;]</span><br><span class="line"># TXT 记录</span><br><span class="line">#txt-record=&lt;name&gt;[[,&lt;text&gt;],&lt;text&gt;]</span><br><span class="line"># PTR 记录 </span><br><span class="line">#ptr-record=&lt;name&gt;[,&lt;target&gt;]</span><br><span class="line">#naptr-record=&lt;name&gt;,&lt;order&gt;,&lt;preference&gt;,&lt;flags&gt;,&lt;service&gt;,&lt;regexp&gt;[,&lt;replacement&gt;]</span><br><span class="line"># CNAME 别名记录</span><br><span class="line">#cname=&lt;cname&gt;,&lt;target&gt;[,&lt;TTL&gt;]</span><br><span class="line">#dns-rr=&lt;name&gt;,&lt;RR-number&gt;,[&lt;hex data&gt;]</span><br><span class="line">#interface-name=&lt;name&gt;,&lt;interface&gt;[/4|/6]</span><br><span class="line">#synth-domain=&lt;domain&gt;,&lt;address range&gt;[,&lt;prefix&gt;]</span><br><span class="line">#add-mac[=base64|text]</span><br><span class="line">#add-cpe-id=&lt;string&gt;</span><br><span class="line">#add-subnet[[=[&lt;IPv4 address&gt;/]&lt;IPv4 prefix length&gt;][,[&lt;IPv6 address&gt;/]&lt;IPv6 prefix length&gt;]]</span><br><span class="line">##############################################################################</span><br><span class="line"></span><br><span class="line"># 缓存条数，默认为150条，cache-size=0 禁用缓存。</span><br><span class="line">cache-size=1000</span><br><span class="line"># 不缓存未知域名缓存，默认情况下dnsmasq缓存未知域名并直接返回为客户端。</span><br><span class="line">no-negcache</span><br><span class="line"># 指定DNS同属查询转发数量</span><br><span class="line">dns-forward-max=1000</span><br><span class="line"></span><br><span class="line">##############################################################################</span><br><span class="line"></span><br><span class="line">#dnssec</span><br><span class="line">#trust-anchor=[&lt;class&gt;],&lt;domain&gt;,&lt;key-tag&gt;,&lt;algorithm&gt;,&lt;digest-type&gt;,&lt;digest&gt;</span><br><span class="line">#dnssec-check-unsigned</span><br><span class="line">#dnssec-no-timecheck</span><br><span class="line">#dnssec-timestamp=&lt;path&gt;</span><br><span class="line">#proxy-dnssec</span><br><span class="line">#dnssec-debug</span><br><span class="line"></span><br><span class="line">##############################################################################</span><br><span class="line"></span><br><span class="line">#auth-server=&lt;domain&gt;,&lt;interface&gt;|&lt;ip-address&gt;</span><br><span class="line">#auth-zone=&lt;domain&gt;[,&lt;subnet&gt;[/&lt;prefix length&gt;][,&lt;subnet&gt;[/&lt;prefix length&gt;].....]]</span><br><span class="line">#auth-zone=&lt;domain&gt;[,&lt;interface name&gt;[/6|/4][,&lt;interface name&gt;[/6|/4].....]]</span><br><span class="line">#auth-soa=&lt;serial&gt;[,&lt;hostmaster&gt;[,&lt;refresh&gt;[,&lt;retry&gt;[,&lt;expiry&gt;]]]]</span><br><span class="line">#auth-sec-servers=&lt;domain&gt;[,&lt;domain&gt;[,&lt;domain&gt;...]]</span><br><span class="line">#auth-peer=&lt;ip-address&gt;[,&lt;ip-address&gt;[,&lt;ip-address&gt;...]]</span><br><span class="line"># 启用连接跟踪，读取 Linux 入栈 DNS 查询请求的连接跟踪标记，</span><br><span class="line"># 并且将上游返回的响应信息设置同样的标记。</span><br><span class="line"># 用于带宽控制和防火墙部署。</span><br><span class="line"># 此选项必须在编译时启用 conntrack 支持，并且内核正确配置并加载 conntrack。</span><br><span class="line"># 此选项不能与 query-port 同时使用。</span><br><span class="line">#conntrack</span><br><span class="line"></span><br><span class="line">##############################################################################</span><br><span class="line">#</span><br><span class="line">#        DHCP 选项</span><br><span class="line">#</span><br><span class="line">##############################################################################</span><br><span class="line"></span><br><span class="line"># 设置 DHCP 地址池，同时启用 DHCP 功能。</span><br><span class="line"># IPv4 &lt;mode&gt; 可指定为 static|proxy ，当 &lt;mode&gt; 指定为 static 时，</span><br><span class="line"># 需用 dhcp-host 手动分配地址池中的 IP 地址。</span><br><span class="line"># 当 &lt;mode&gt; 指定为 proxy 时，为指定的地址池提供 DHCP 代理。</span><br><span class="line">#dhcp-range=[tag:&lt;tag&gt;[,tag:&lt;tag&gt;],][set:&lt;tag&gt;,]&lt;start-addr&gt;[,&lt;end-addr&gt;][,&lt;mode&gt;][,&lt;netmask&gt;[,&lt;broadcast&gt;]][,&lt;lease time&gt;]</span><br><span class="line">#dhcp-range=172.16.0.2,172.16.0.250,255.255.255.0,1h</span><br><span class="line">#dhcp-range=192.168.10.150,192.168.10.180,static,255.255.255.0,1h</span><br><span class="line"># 根据 MAC 地址或 id 固定分配客户端的 IP 地址、主机名、租期。</span><br><span class="line"># IPv4 下指定 id:* 将忽略 DHCP 客户端的 ID ，仅根据 MAC 来进行 IP 地址分配。</span><br><span class="line"># 在读取 /etc/hosts 的情况，也可以根据 /etc/hosts 中的主机名分配对应 IP 地址。</span><br><span class="line"># 指定 ignore 将忽略指定客户端得 DHCP 请求。</span><br><span class="line">#dhcp-host=[&lt;hwaddr&gt;][,id:&lt;client_id&gt;|*][,set:&lt;tag&gt;][,&lt;ipaddr&gt;][,&lt;hostname&gt;][,&lt;lease_time&gt;][,ignore]</span><br><span class="line">#dhcp-hostsfile=&lt;path&gt;</span><br><span class="line">#dhcp-hostsdir=&lt;path&gt;</span><br><span class="line"># 读取 /etc/ethers 文件 与使用 dhcp-host 的作用相同。IPv6 无效。</span><br><span class="line">#read-ethers</span><br><span class="line"># 指定给 DHCP 客户端的选项信息，</span><br><span class="line"># 默认情况下 dnsmasq 将发送：子网掩码、广播地址、DNS 服务器地址、网关地址、域等信息。</span><br><span class="line"># 指定此选项也可覆盖这些默认值并且设置其他选项值。</span><br><span class="line"># 重要：可以使用 option:&lt;option-name&gt;或者 option号 来指定。</span><br><span class="line"># &lt;option-name&gt; 和 option号的对应关系可使用命令：</span><br><span class="line"># dnsmasq --help dhcp 以及 dnsmasq --help dhcp6 查看，这点很重要。</span><br><span class="line"># 例如设置网关参数，既可以使用 dhcp-option=3,192.168.4.4 也可以使用 dhcp-option = option:router,192.168.4.4。</span><br><span class="line"># 0.0.0.0 意味着当前运行 dnsmasq 的主机地址。</span><br><span class="line"># 如果指定了多个 tag:&lt;tag&gt; 必须同时匹配才行。</span><br><span class="line"># [encap:&lt;opt&gt;,][vi-encap:&lt;enterprise&gt;,][vendor:[&lt;vendor-class&gt;],] 有待继续研究。</span><br><span class="line">#dhcp-option=[tag:&lt;tag&gt;,[tag:&lt;tag&gt;,]][encap:&lt;opt&gt;,][vi-encap:&lt;enterprise&gt;,][vendor:[&lt;vendor-class&gt;],][&lt;opt&gt;|option:&lt;opt-name&gt;|option6:&lt;opt&gt;|option6:&lt;opt-name&gt;],[&lt;value&gt;[,&lt;value&gt;]]</span><br><span class="line">#dhcp-option-force=[tag:&lt;tag&gt;,[tag:&lt;tag&gt;,]][encap:&lt;opt&gt;,][vi-encap:&lt;enterprise&gt;,][vendor:[&lt;vendor-class&gt;],]&lt;opt&gt;,[&lt;value&gt;[,&lt;value&gt;]]</span><br><span class="line">#dhcp-optsfile=&lt;path&gt;</span><br><span class="line">#dhcp-optsdir=&lt;path&gt;</span><br><span class="line">#dhcp-option=3,1.2.3.4</span><br><span class="line">#dhcp-option=option:router,1.2.3.4</span><br><span class="line">#dhcp-option=option:router,192.168.10.254</span><br><span class="line">#dhcp-option=option:dns-server,192.168.10.254,221.12.1.227,221.12.33.227</span><br><span class="line"></span><br><span class="line">##############################################################################</span><br><span class="line"></span><br><span class="line"># (IPv4 only) 禁用重用服务器名称和文件字段作为额外的 dhcp-option 选项。</span><br><span class="line"># 一般情况下 dnsmasq 从 dhcp-boot 移出启动服务器和文件信息到 dhcp-option 选项中。</span><br><span class="line"># 这使得在 dhcp-option 选项封包中有额外的选项空间可用，但是会使老的客户端混淆。</span><br><span class="line"># 此选项将强制使用简单并安全的方式来避免此类情况。可以认为是一个兼容性选项。</span><br><span class="line">#dhcp-no-override</span><br><span class="line">##############################################################################</span><br><span class="line"></span><br><span class="line"># 配置 DHCP 中继。</span><br><span class="line"># &lt;local address&gt; 是运行 dnsmasq 的接口的 IP 地址。</span><br><span class="line"># 所有在 &lt;local address&gt; 接口上接收到的 DHCP 请求将中继到 &lt;server address&gt; 指定的远程 DHCP 服务器。</span><br><span class="line"># 可以多次配置此选项，使用同一个 &lt;local address&gt; 转发到多个不同的 &lt;server address&gt; 指定的远程 DHCP 服务器。</span><br><span class="line"># &lt;server address&gt; 仅允许使用 IP 地址，不能使用域名等其他格式。</span><br><span class="line"># 如果是 DHCPv6，&lt;server address&gt; 可以是 ALL_SERVERS 的多播地址 ff05::1:3 。</span><br><span class="line"># 在这种情况下必须指定接口 &lt;interface&gt; ，不能使用通配符，用于直接多播到对应的 DHCP 服务器所在的接口。</span><br><span class="line"># &lt;interface&gt; 指定了仅允许接收从 &lt;interface&gt; 接口的 DHCP 服务器相应信息。</span><br><span class="line">#dhcp-relay=&lt;local address&gt;,&lt;server address&gt;[,&lt;interface&gt;]</span><br><span class="line">##############################################################################</span><br><span class="line"></span><br><span class="line"># 设置标签</span><br><span class="line">#dhcp-vendorclass=set:&lt;tag&gt;,[enterprise:&lt;IANA-enterprise number&gt;,]&lt;vendor-class&gt;</span><br><span class="line">#dhcp-userclass=set:&lt;tag&gt;,&lt;user-class&gt;</span><br><span class="line">#dhcp-mac=set:&lt;tag&gt;,&lt;MAC address&gt;</span><br><span class="line">#dhcp-circuitid=set:&lt;tag&gt;,&lt;circuit-id&gt;</span><br><span class="line">#dhcp-remoteid=set:&lt;tag&gt;,&lt;remote-id&gt;</span><br><span class="line">#dhcp-subscrid=set:&lt;tag&gt;,&lt;subscriber-id&gt;</span><br><span class="line">#dhcp-match=set:&lt;tag&gt;,&lt;option number&gt;|option:&lt;option name&gt;|vi-encap:&lt;enterprise&gt;[,&lt;value&gt;]</span><br><span class="line">#tag-if=set:&lt;tag&gt;[,set:&lt;tag&gt;[,tag:&lt;tag&gt;[,tag:&lt;tag&gt;]]]</span><br><span class="line">#dhcp-proxy[=&lt;ip addr&gt;]......</span><br><span class="line"></span><br><span class="line"> ##############################################################################</span><br><span class="line"># 不分配匹配这些 tag:&lt;tag&gt; 的 DHCP 请求。</span><br><span class="line">#dhcp-ignore=tag:&lt;tag&gt;[,tag:&lt;tag&gt;]</span><br><span class="line">#dhcp-ignore-names[=tag:&lt;tag&gt;[,tag:&lt;tag&gt;]]</span><br><span class="line">#dhcp-generate-names=tag:&lt;tag&gt;[,tag:&lt;tag&gt;]</span><br><span class="line"># IPv4 only 使用广播与匹配 tag:&lt;tag&gt; 的客户端通信。一般用于兼容老的 BOOT 客户端。</span><br><span class="line">#dhcp-broadcast[=tag:&lt;tag&gt;[,tag:&lt;tag&gt;]] </span><br><span class="line"></span><br><span class="line">##############################################################################</span><br><span class="line"># IPv4 only 设置 DHCP 服务器返回的 BOOTP 选项，</span><br><span class="line"># &lt;servername&gt; &lt;server address&gt; 可选，</span><br><span class="line"># 如果未设置服务器名称将设为空，服务器地址设为 dnsmasq 的 IP 地址。</span><br><span class="line"># 如果指定了多个 tag:&lt;tag&gt; 必须同时匹配才行。</span><br><span class="line"># 如果指定 &lt;tftp_servername&gt; 将按照 /etc/hosts 中对应的 IP 地址进行轮询负载均衡。  </span><br><span class="line">#dhcp-boot=[tag:&lt;tag&gt;,]&lt;filename&gt;,[&lt;servername&gt;[,&lt;server address&gt;|&lt;tftp_servername&gt;]]</span><br><span class="line"># 根据不同的类型使用不同的选项。</span><br><span class="line"># 使用示例：</span><br><span class="line">#        dhcp-match=set:EFI_x86-64,option:client-arch,9</span><br><span class="line">#        dhcp-boot=tag:EFI_x86-64,uefi/grubx64.efi</span><br><span class="line">#        #dhcp-match=set:EFI_Xscale,option:client-arch,8</span><br><span class="line">#        #dhcp-boot=tag:EFI_Xscale,uefi/grubx64.efi</span><br><span class="line">#        #dhcp-match=set:EFI_BC,option:client-arch,7</span><br><span class="line">#        #dhcp-boot=tag:EFI_BC,uefi/grubx64.efi</span><br><span class="line">#        #dhcp-match=set:EFI_IA32,option:client-arch,6</span><br><span class="line">#        #dhcp-boot=tag:EFI_IA32,uefi/grubx64.efi</span><br><span class="line">#        #dhcp-match=set:Intel_Lean_Client,option:client-arch,5</span><br><span class="line">#        #dhcp-boot=tag:Intel_Lean_Client,uefi/grubx64.efi</span><br><span class="line">#        #dhcp-match=set:Arc_x86,option:client-arch,4</span><br><span class="line">#        #dhcp-boot=tag:Arc_x86,uefi/grubx64.efi</span><br><span class="line">#        #dhcp-match=set:DEC_Alpha,option:client-arch,3</span><br><span class="line">#        #dhcp-boot=tag:DEC_Alpha,uefi/grubx64.efi</span><br><span class="line">#        #dhcp-match=set:EFI_Itanium,option:client-arch,2</span><br><span class="line">#        #dhcp-boot=tag:EFI_Itanium,uefi/grubx64.efi</span><br><span class="line">#        #dhcp-match=set:NEC/PC98,option:client-arch,1</span><br><span class="line">#        #dhcp-boot=tag:NEC/PC98,uefi/grubx64.efi</span><br><span class="line">#        dhcp-match=set:Intel_x86PC,option:client-arch,0</span><br><span class="line">#        dhcp-boot=tag:Intel_x86PC,pxelinux.0</span><br><span class="line">##############################################################################</span><br><span class="line"></span><br><span class="line"># DHCP 使用客户端的 MAC 地址的哈希值为客户端分配 IP 地址，</span><br><span class="line"># 通常情况下即使客户端使自己的租约到期，客户端的 IP 地址仍将长期保持稳定。</span><br><span class="line"># 在默认模式下，IP 地址是随机分配的。</span><br><span class="line"># 启用 dhcp-sequential-ip 选项将按顺序分配 IP 地址。</span><br><span class="line"># 在顺序分配模式下，客户端使租约到期更像是仅仅移动一下 IP 地址。</span><br><span class="line"># 在通常情况下不建议使用这种方式。</span><br><span class="line">#dhcp-sequential-ip</span><br><span class="line"></span><br><span class="line">##############################################################################</span><br><span class="line"># 多数情况下我们使用 PXE，只是简单的允许 PXE 客户端获取 IP 地址，</span><br><span class="line"># 然后 PXE 客户端下载 dhcp-boot 选项指定的文件并执行，也就是 BOOTP 的方式。</span><br><span class="line"># 然而在有适当配置的 DHCP 服务器支持的情况下，PXE 系统能够实现更复杂的功能。</span><br><span class="line"># pxe-service 选项可指定 PXE 环境的启动菜单。</span><br><span class="line"># 为不同的类型系统设定不同的启动菜单，并且覆盖 dhcp-boot 选项。</span><br><span class="line"># &lt;CSA&gt; 为客户端系统类型：x86PC, PC98, IA64_EFI, Alpha, Arc_x86, Intel_Lean_Client, </span><br><span class="line"># IA32_EFI, X86-64_EFI, Xscale_EFI, BC_EFI, ARM32_EFI 和 ARM64_EFI，其他类型可能为一个整数。</span><br><span class="line"># &lt;basename&gt; 引导 PXE 客户端使用 tftp 从 &lt;server address&gt; 或者 &lt;server_name&gt; 下载文件。</span><br><span class="line">#     注意：&quot;layer&quot; 后缀 (通常是 &quot;.0&quot;) 由 PXE 提供，也就是 PXE 客户端默认在文件名附加 .0 后缀。</span><br><span class="line">#     示例：pxe-service=x86PC, &quot;Install Linux&quot;, pxelinux         （读取 pxelinux.0 文件并执行）</span><br><span class="line">#           pxe-service=x86PC, &quot;Install Linux&quot;, pxelinux, 1.2.3.4（不适用于老的PXE）</span><br><span class="line">#     &lt;bootservicetype&gt; 整数，PXE 客户端将通过广播或者通过 &lt;server address&gt; </span><br><span class="line">#           或者 &lt;server_name&gt; 搜索对应类型的适合的启动服务。。</span><br><span class="line">#     示例：pxe-service=x86PC, &quot;Install windows from RIS server&quot;, 1</span><br><span class="line">#           pxe-service=x86PC, &quot;Install windows from RIS server&quot;, 1, 1.2.3.4</span><br><span class="line">#     未指定 &lt;basename&gt;、&lt;bootservicetype&gt; 或者 &lt;bootservicetype&gt; 为 “0”，将从本地启动。</span><br><span class="line">#     示例：pxe-service=x86PC, &quot;Boot from local disk&quot;</span><br><span class="line">#           pxe-service=x86PC, &quot;Boot from local disk&quot;, 0</span><br><span class="line"># 如果指定 &lt;server_name&gt; 将按照 /etc/hosts 中对应的 IP 地址进行轮询负载均衡。  </span><br><span class="line">#pxe-service=[tag:&lt;tag&gt;,]&lt;CSA&gt;,&lt;menu text&gt;[,&lt;basename&gt;|&lt;bootservicetype&gt;][,&lt;server address&gt;|&lt;server_name&gt;]</span><br><span class="line"># 在 PXE 启动后弹出提示，&lt;prompt&gt; 为提示内容，&lt;timeout&gt; 为超时时间，为 0 则立即执行。</span><br><span class="line"># 如果未指定此选项，在有多个启动选项的情况下等待用户选择，不会超时。</span><br><span class="line">#pxe-prompt=[tag:&lt;tag&gt;,]&lt;prompt&gt;[,&lt;timeout&gt;]</span><br><span class="line"># 根据不同的类型使用不同的菜单，使用示例：</span><br><span class="line">#        #pxe-prompt=&quot;What system shall I netboot?&quot;, 120</span><br><span class="line">#        # or with timeout before first available action is taken:</span><br><span class="line">#        pxe-prompt=&quot;Press F8 or Enter key for menu.&quot;, 60</span><br><span class="line">#        pxe-service=x86PC, &quot;Now in x86PC (BIOS mode), boot from local&quot;, 0</span><br><span class="line">#        pxe-service=x86PC, &quot;Now in x86PC (BIOS mode)&quot;, pxelinux</span><br><span class="line">#        pxe-service=PC98, &quot;Now in PC98 mode&quot;, PC98</span><br><span class="line">#        pxe-service=IA64_EFI, &quot;Now in IA64_EFI mode&quot;, IA64_EFI</span><br><span class="line">#        pxe-service=Alpha, &quot;Now in Alpha mode&quot;, Alpha</span><br><span class="line">#        pxe-service=Arc_x86, &quot;Now in Arc_x86 mode&quot;, Arc_x86</span><br><span class="line">#        pxe-service=Intel_Lean_Client, &quot;Now in Intel_Lean_Client mode&quot;, Intel_Lean_Client</span><br><span class="line">#        pxe-service=IA32_EFI, &quot;Now in IA32_EFI mode&quot;, IA32_EFI</span><br><span class="line">#        pxe-service=X86-64_EFI, &quot;Now in X86-64_EFI (UEFI mode), boot from local&quot;, 0</span><br><span class="line">#        pxe-service=X86-64_EFI, &quot;Now in X86-64_EFI (UEFI mode)&quot;, grub/grub-x86_64.efi</span><br><span class="line">#        pxe-service=Xscale_EFI, &quot;Now in Xscale_EFI mode&quot;, Xscale_EFI</span><br><span class="line">#        pxe-service=BC_EFI, &quot;Now in BC_EFI mode&quot;, BC_EFI</span><br><span class="line">#        # CentOS7 系统不支持下列两个选项</span><br><span class="line">#        #pxe-service=ARM32_EFI,&quot;Now in ARM32_EFI mode&quot;,ARM32_EFI</span><br><span class="line">#        #pxe-service=ARM64_EFI,&quot;Now in ARM64_EFI mode&quot;,ARM64_EFI</span><br><span class="line"></span><br><span class="line">##############################################################################</span><br><span class="line"># 默认为150，即最多分配150个ip地址出去，最大1000个ip</span><br><span class="line">#dhcp-lease-max=150</span><br><span class="line"># (IPv4 only) 指定DHCP端口，默认为67和68。如果不指定则为1067和1068，单指定一个，第二个加1</span><br><span class="line">#dhcp-alternate-port[=&lt;server port&gt;[,&lt;client port&gt;]]</span><br><span class="line"># 谨慎使用此选项，避免 IP 地址浪费。(IPv4 only) 允许动态分配 IP 地址给 BOOTP 客户端。</span><br><span class="line"># 注意：BOOTP 客户端获取的 IP 地址是永久的，将无法再次分配给其他客户端。</span><br><span class="line">#bootp-dynamic[=&lt;network-id&gt;[,&lt;network-id&gt;]]</span><br><span class="line"># 谨慎使用此选项。</span><br><span class="line"># 默认情况下 DHCP 服务器使用 ping 的方式进行确保 IP 未被使用的情况下将 IP 地址分配出去。</span><br><span class="line"># 启用此选项将不使用 ping 进行确认。</span><br><span class="line">#no-ping</span><br><span class="line"></span><br><span class="line">##############################################################################</span><br><span class="line"># 记录额外的 dhcp 日志，记录所有发送给 DHCP 客户端的选项（option）以及标签（tag）信息</span><br><span class="line">#log-dhcp</span><br><span class="line"># 禁止记录日常操作日志，错误日志仍然记录。启用 log-dhcp 将覆盖下列选项。</span><br><span class="line">#quiet-dhcp</span><br><span class="line">#quiet-dhcp6</span><br><span class="line">#quiet-ra</span><br><span class="line"># 修改 DHCP 默认租约文件路径，默认情况下无需修改</span><br><span class="line">#dhcp-leasefile=/var/lib/dnsmasq/dnsmasq.leases</span><br><span class="line"># (IPv6 only)</span><br><span class="line">#dhcp-duid=&lt;enterprise-id&gt;,&lt;uid&gt;</span><br><span class="line"></span><br><span class="line">##############################################################################</span><br><span class="line">#dhcp-script=&lt;path&gt;</span><br><span class="line">#dhcp-luascript=&lt;path&gt;</span><br><span class="line">#dhcp-scriptuser=root</span><br><span class="line">#script-arp</span><br><span class="line">#leasefile-ro</span><br><span class="line">#bridge-interface=&lt;interface&gt;,&lt;alias&gt;[,&lt;alias&gt;]</span><br><span class="line"></span><br><span class="line">##############################################################################</span><br><span class="line"># 给 DHCP 服务器指定 domain 域名信息，也可以给对应的 IP 地址池指定域名。</span><br><span class="line">#     直接指定域名</span><br><span class="line">#     示例：domain=thekelleys.org.uk</span><br><span class="line">#     子网对应的域名</span><br><span class="line">#     示例：domain=wireless.thekelleys.org.uk,192.168.2.0/24</span><br><span class="line">#     ip范围对应的域名</span><br><span class="line">#     示例：domain=reserved.thekelleys.org.uk,192.68.3.100,192.168.3.200</span><br><span class="line">#domain=&lt;domain&gt;[,&lt;address range&gt;[,local]]</span><br><span class="line"># 在默认情况下 dnsmasq 插入普通的客户端主机名到 DNS 中。</span><br><span class="line"># 在这种情况下主机名必须唯一，即使两个客户端具有不同的域名后缀。</span><br><span class="line"># 如果第二个客户端使用了相同的主机名，DNS 查询将自动更新为第二个客户端的 IP 地址。</span><br><span class="line"># 如果设置了 dhcp-fqdn 选项，普通的主机名将不再插入到 DNS 中去，</span><br><span class="line"># 仅允许合格的具有域名后缀的主机名插入到 DNS 服务器中。</span><br><span class="line"># 指定此选项需同时指定不含 &lt;address range&gt; 地址范围的 domain 选项。</span><br><span class="line">#dhcp-fqdn</span><br><span class="line"># 通常情况下分配 DHCP 租约后，dnsmasq 设置 FQDN 选项告诉客户端不要尝试 DDNS 更新主机名与 IP 地址。</span><br><span class="line"># 这是因为  name-IP 已自动添加到 dnsmasq 的 DNS 视图中的。</span><br><span class="line"># 设置此选项将允许客户端 DDNS 更新，</span><br><span class="line"># 在 windows 下允许客户端更新 windows AD 服务器是非常有用的。</span><br><span class="line"># 参看  RFC 4702 。</span><br><span class="line">#dhcp-client-update</span><br><span class="line">#enable-ra</span><br><span class="line">#ra-param=&lt;interface&gt;,[high|low],[[&lt;ra-interval&gt;],&lt;router lifetime&gt;]</span><br><span class="line"></span><br><span class="line">##############################################################################</span><br><span class="line">#</span><br><span class="line">#        TFTP 选项</span><br><span class="line">#</span><br><span class="line">##############################################################################</span><br><span class="line"></span><br><span class="line"># 对于绝大多数的配置，仅需指定 enable-tftp 和 tftp-root 选项即可。</span><br><span class="line"># 是否启用内置的 tftp 服务器，可以指定多个逗号分隔的网络接口</span><br><span class="line">#enable-tftp[=&lt;interface&gt;[,&lt;interface&gt;]]</span><br><span class="line">#enable-tftp</span><br><span class="line">#enable-tftp=enp3s0,lo</span><br><span class="line"># 指定 tftp 的根目录，也就是寻找传输文件时使用的相对路径，可以附加接口，</span><br><span class="line">#tftp-root=&lt;directory&gt;[,&lt;interface&gt;]</span><br><span class="line">#tftp-root=/var/lib/tftpboot/</span><br><span class="line"># 如果取消注释，那么即使指定的 tftp-root 无法访问，仍然启动 tftp 服务。</span><br><span class="line">#tftp-no-fail</span><br><span class="line"># 附加客户端的 IP 地址作为文件路径。此选项仅在正确设置了 tftp-root 的情况下可用，</span><br><span class="line"># 示例：如果 tftp-root=/tftp，客户端为 192.168.1.15 请求 myfile.txt 文件时，</span><br><span class="line"># 将优先请求 /tftp/192.168.1.15/myfile.txt 文件， 其次是 /tftp/myfile.txt 文件。</span><br><span class="line"># 感觉没什么用。</span><br><span class="line">#tftp-unique-root</span><br><span class="line"># 启用安全模式，启用此选项，仅允许 tftp 进程访问属主为自己的文件。</span><br><span class="line"># 不启用此选项，允许访问所有 tftp 进程属主可读取的文件。</span><br><span class="line"># 如果 dnsmasq 是以 root 用户运行，tftp-secure 选项将允许访问全局可读的文件。</span><br><span class="line"># 一般情况下不推荐以 root 用户运行 dnsmasq。</span><br><span class="line"># 在指定了 tftp-root 的情况下并不是很重要。</span><br><span class="line">#tftp-secure</span><br><span class="line"># 将所有文件请求转换为小写。对于 Windows 客户端来说非常有用，建议开启此项。</span><br><span class="line"># 注意：dnsmasq 的 TFTP 服务器总是将文件路径中的“\”转换为“/”。</span><br><span class="line">#tftp-lowercase</span><br><span class="line"># 允许最大的连接数，默认为 50 。</span><br><span class="line"># 如果将连接数设置的很大，需注意每个进程的最大文件描述符限制，详见文档手册。</span><br><span class="line">#tftp-max=&lt;connections&gt;</span><br><span class="line">#tftp-max=50</span><br><span class="line"># 设置传输时的 MTU 值，建议不设置或按需设置。</span><br><span class="line"># 如果设定的值大于网络接口的 MTU 值，将按照网络接口的 MTU 值自动分片传输（不推荐）。</span><br><span class="line">#tftp-mtu=&lt;mtu size&gt;</span><br><span class="line"># 停止 tftp 服务器与客户端协商 &quot;blocksize&quot; 选项。启用后，防止一些古怪的客户端出问题。</span><br><span class="line">#tftp-no-blocksize</span><br><span class="line"># 指定 tftp 的连接端口的范围，方便防火墙部署。</span><br><span class="line"># tftp 侦听在 69/udp ，连接端口默认是由系统自动分配的，</span><br><span class="line"># 非 root 用户运行时指定的连接端口号需大于 1025 最大 65535。</span><br><span class="line">#tftp-port-range=&lt;start&gt;,&lt;end&gt;</span><br><span class="line"></span><br><span class="line">###############################################################################</span><br><span class="line"></span><br><span class="line">#conf-dir=&lt;directory&gt;[,&lt;file-extension&gt;......]</span><br><span class="line">#conf-file=/etc/dnsmasq.more.conf</span><br><span class="line">conf-dir=/etc/dnsmasq.d</span><br><span class="line">#servers-file=&lt;file&gt;</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/DD-WRT/" rel="tag"># DD-WRT</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2018/08/31/openvpn/" rel="prev" title="openvpn安装与配置">
                  <i class="fa fa-chevron-left"></i> openvpn安装与配置
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2018/09/13/ffmpeg/" rel="next" title="ffmpeg用法">
                  ffmpeg用法 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Tiki</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  





</body>
</html>
